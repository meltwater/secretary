# Secretary
Secrets distribution for dynamic container environments

## Description

It uses Marathon as the source of truth about what service can access what secret and uses Marathon to find out the public key of an application.

So it can authenticate the service asking for the secret. It should be very secure and also at least as easy to use as heira-yaml.

It is more secure than heira-yaml since secrets are never stored on disk or visible outside the container.

## How does it also solves the initial secret problem ?

The application docker image embeds a private key that is root-readable, read by the docker container start script that asks secretary-daemon for secrets and then the app (unpriv user) can't access the private key.

The secrets are encrypted two times, inner box is with secretary-daemon master key, outer level with application key.

The app public key is deployed to Nexus and retrieved by [Lighter](https://github.com/meltwater/lighter) at deployment time.

## What Steps are needed to get the plaintext password of mysql for example

There's 3 things that are needed to get the plaintext :

- app private key
- secret from config repo
- network access

with vault/keywhiz there's only 2 things needed :

- token from config repo
- network access

## System components

## Data model

The master/config keys are created once and for each environment using "secretary genkeys"

The master private key is stored on master nodes

The config key stored in marathon-site repo

The app key is generated at app build time, the private app key stored in image and the public app key deployed to Nexus/Maven.

The app keys can be generated at any time and they're rolled up for each app build. So every time the app builds, it gets a new key.

The config public/private keys and the master public key are stored in marathon-site, so anyone can encrypt secrets and put them into marathon-site

If the config private key (used for signing the encrypted secrets) isn't stored in marathon-site then someone else with access to that private key needs to encrypt the secrets

## Setup

## Examples

## Contributing

## License



## TODO

* Encrypt with svc key when deploying. Test for svckey in app env by encryption configenvelope with candidate nonce and config/master keys and then string compare
* Lighter looks for a type:pem in maven when deploying and send it along in service_public_key
* Needs to declare as insecure service to get autogenerated svckey by lighter. Error if enc envvar present by no key in maven or insecure deckared
* Sign/encrypt query parameters in decrypt request to daemon (pack all of them into envelope)
* Setuid secretary-cgi that decrypts the master key to avoid
  giving `secretary daemon` direct access to master private key.

## Examples

```
# One level encryption for writing into deployment config files
echo -n secret | ./secretary encrypt

# Two level deployment encryption for writing into runtime service config
echo -n secret | ./secretary encrypt | ./secretary encrypt --public-key=./keys/config-public-key.pem

# Decrypt one level encryption
echo <encrypted> | ./secretary decrypt

# Decrypt two level encryption
echo <encrypted> | ./secretary decrypt --private-key=./keys/config-private-key.pem | ./secretary decrypt

# Decrypt two level using daemon
./secretary daemon
echo <encrypted> | ./secretary decrypt --private-key=./keys/config-private-key.pem | ./secretary decrypt
```
